-- Migration SQL for View Count and Rating System
-- Copy and run this in Turso Console

-- Step 1: Add new columns to Manga table
ALTER TABLE "Manga" ADD COLUMN "viewCount" INTEGER NOT NULL DEFAULT 0;
ALTER TABLE "Manga" ADD COLUMN "ratingSum" INTEGER NOT NULL DEFAULT 0;
ALTER TABLE "Manga" ADD COLUMN "ratingCount" INTEGER NOT NULL DEFAULT 0;
ALTER TABLE "Manga" ADD COLUMN "averageRating" REAL NOT NULL DEFAULT 0.0;

-- Step 2: Create MangaRating table
CREATE TABLE "MangaRating" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "mangaId" TEXT NOT NULL,
    "fingerprint" TEXT NOT NULL,
    "ipAddress" TEXT,
    "rating" INTEGER NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("mangaId") REFERENCES "Manga"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Step 3: Create unique constraint for mangaId + fingerprint
CREATE UNIQUE INDEX "MangaRating_mangaId_fingerprint_key" ON "MangaRating"("mangaId", "fingerprint");

-- Step 4: Create indexes for better performance
CREATE INDEX "MangaRating_mangaId_idx" ON "MangaRating"("mangaId");
CREATE INDEX "MangaRating_fingerprint_idx" ON "MangaRating"("fingerprint");

-- Step 5: Create index on Manga for sorting by views and ratings
CREATE INDEX "Manga_viewCount_idx" ON "Manga"("viewCount" DESC);
CREATE INDEX "Manga_averageRating_idx" ON "Manga"("averageRating" DESC);

-- Verification queries (uncomment to use):
-- SELECT sql FROM sqlite_master WHERE type='table' AND name='Manga';
-- SELECT sql FROM sqlite_master WHERE type='table' AND name='MangaRating';
